/**
 * 提示词模板管理模块
 * 
 * 该模块负责管理所有的提示词模板，分为两类：
 * 1. 元提示词（Meta Prompts）：用于生成其他提示词的提示词
 * 2. 内容生成提示词（Content Generation Prompts）：直接用于生成最终内容的提示词
 */

// ==================== 元提示词（用于生成其他提示词） ====================

/**
 * 获取门诊病历的元提示词，用于生成自定义的内容生成提示词
 * @param {string} templateFields - 用户选择的字段列表，如 "主诉,现病史,治疗建议"
 * @returns {string} 用于生成门诊病历提示词的元提示词
 */
function getMetaPromptForOutpatient(templateFields) {
  return `请根据医生勾选的字段，生成一段用于引导AI生成门诊病历的Prompt。
你需要为每个字段生成：
1.字段名作为小标题
2.合规的编写说明（重点标出红线禁忌）
3.该字段的示例格式
4.仅输出纯文本，不带格式
所有内容最终整合为一个完整的引导Prompt，医生可用于生成病历草稿。

字段说明如下：
主诉
原样转述患者的表达，禁止加入判断。
示例：
主诉：
夜间排尿频繁 2 天。

现病史
合理整理症状发展时间线，但禁止写诊断。
示例：
现病史：
2 天前出现夜尿增多，次日伴有轻度尿痛，无发热。

既往史
客观记录真实既往疾病经历，避免主观评价。
示例：
既往史：
患有高血压病史 5 年，否认泌尿系相关疾病史。

体格检查
仅限医生所述内容，不能编造或AI模拟检查结果。
示例：
体格检查：
腹部平软，无压痛，无肿块。

辅助检查建议
不得AI主动提出CT、血检等敏感检查；可复述医生语句方向。
示例：
辅助检查建议：
建议结合病情进行泌尿系统B超检查。

初步诊断
禁止直接输出诊断结果，避免使用"符合"、"建议诊断为"等词汇。
示例：
初步诊断：
建议结合临床表现初步考虑泌尿系统功能异常。

治疗建议
禁止具体药名、剂量、频次；可描述治疗目标和方向。
示例：
治疗建议：
可考虑对症缓解排尿不适，具体用药由医生判断。

请根据医生输入的字段（例如：主诉、现病史、治疗建议），只生成对应字段的引导内容，不要生成未勾选的项。
确保所有内容合规、明确、不包含医疗建议、诊断结论、处方信息。

医生勾选的字段为：${templateFields}`
}

/**
 * 获取教育查房的元提示词，用于生成自定义的内容生成提示词
 * @param {string} templateFields - 用户选择的字段列表
 * @returns {string} 用于生成教育查房提示词的元提示词
 */
function getMetaPromptForEducationRound(templateFields) {
  return `你是一个提示词生成助手，我将为你提供若干字段，你的任务是生成一段引导AI生成教育查房的Prompt。

请生成的Prompt满足以下要求：
你需要为每个字段生成：
1.字段名作为小标题
2.合规的编写说明（重点标出红线禁忌）
3.该字段的示例格式
4.仅输出纯文本，不带格式

不得编造未提供的信息；
输出结构可包含但不限于：患者信息概览、带教老师提问、规培医生回答、老师点评、诊疗讨论、总结建议等字段；
输出格式为一段完整可用的Prompt，适合直接输入到语言模型中使用。
请根据我输入的字段自动生成该Prompt。仅输出生成的Prompt本身，不需要额外说明。

输出示例：

病例汇报：规培医生先讲患者的基本情况——主诉、现病史、体格检查、化验、影像这些。格式跟普通查房差不多，但得说得更规范一点。
现场提问：带教老师插话提问，比如问诊断思路、鉴别诊断、可能的并发症、治疗原则。这段对话最有教学价值。
病例分析与点评：老师对整个病例进行分析，指出规培医生的不足，讲授临床思路、指南依据，甚至历史病例做比较。
治疗讨论：团队围绕治疗方案展开讨论，有时也会提到新的治疗方向、科研价值啥的。
总结提升：最后老师通常会升华一下，比如讲点临床哲学、职业态度，规培医生还得反思自我。

字段为：${templateFields}`
}

// ==================== 内容生成提示词（直接用于生成内容） ====================

/**
 * 获取查房记录的内容生成提示词
 * @param {string} dialogueContent - 对话内容
 * @returns {string} 用于生成查房记录的提示词
 */
function getContentPromptForWardRound(dialogueContent) {
  return `你是一个临床查房记录整理助手，需要根据以下带角色标签的对话，生成标准查房记录。

查房时间：____  
床号：____

主观情况：  
（根据[患者]的发言，整理为患者自述的感受和症状。）

客观情况：  
（根据[护士]的发言，整理生命体征、观察情况、设备状态等。若未提及生命体征，请写："生命体征未在语音中提及，请补充测量结果。"）

综合评估：  
（根据[护士]的总结性发言，进行模糊评估，例如"生命体征平稳"，"病情较前好转"等，禁止下诊断。）

护理建议：  
（根据护士或医生的内容，总结护理措施，如"继续常规观察"，"鼓励活动"等，严禁包含处方、剂量、诊疗方案。）

【以下为可选拓展段，满足条件时生成】：

病情变化记录：  
（当对话中出现"突发"、"恶化"、"加重"等内容时，生成简要说明。）

患者或家属沟通情况：  
（若出现沟通、解释、同意、配合等相关内容时生成。）

情绪及依从性记录：  
（若患者情绪明显或存在不配合、焦虑等情况，生成此段。）

设备使用状态：  
（如涉及呼吸机、心电监护、导尿、引流装置等内容时生成。）

输出要求：
每一段落标题保持不变，未触发的拓展段落可省略
所有文字使用临床中文表达风格，不添加AI或系统标注
禁止生成诊断名称、药物名称、处方内容

以下是待处理的带角色对话内容：${dialogueContent}

输出示例：
title: 主观情况：  
content: 患者诉昨夜睡眠欠佳，腹部轻度胀感，较昨日减轻。无恶心、呕吐等不适。  

title: 客观情况：  
content: 体温36.8℃，血压122/80 mmHg，脉搏86次/分，呼吸正常。腹部柔软无压痛，导尿管通畅，引流袋无异常。`
}

/**
 * 获取随访记录的内容生成提示词
 * @param {string} dialogueContent - 对话内容
 * @returns {string} 用于生成随访记录的提示词
 */
function getContentPromptForFollowup(dialogueContent) {
  return `你是一名临床随访记录助手，请根据以下带有角色标签的对话内容，整理生成一份标准随访记录。
请按照如下格式输出内容：

基本情况：  
（根据[患者]或[家属]的发言，整理患者的恢复状况，如是否有不适、饮食、睡眠、伤口恢复等。）

治疗依从性：  
（是否按时服药、是否遵医嘱复查或康复锻炼，如未执行可如实记录。）

复发或异常情况：  
（是否有不适、复发或新的症状，如发热、伤口不适等。若无异常可写"未见明显异常"。）

患者反馈：  
（对治疗效果的看法、生活影响、情绪状态等主观评价。若无具体表达可省略。）

处理建议：  
（根据随访内容，提出后续建议，如继续观察、建议复查、保持锻炼等，禁止包含明确诊断或处方内容。）

【以下为条件触发的可选拓展段】：

家属协助记录：  
（若对话中出现家属角色或由家属代答，说明家属协助情况。）

心理状态记录：  
（若对话中出现"烦躁""焦虑""没信心"等情绪性内容，添加此段。）

重点事项提醒：  
（若随访人员强调复查、服药、饮食等，提取为关键提醒。）

输出规范：
- 若某部分信息缺失，请写"未在对话中提及"或"暂无相关内容"
- 禁止输出"诊断结论""药品名称"或"处方建议"
- 仅输出整理后的内容，不重复对话原文

以下是对话内容：${dialogueContent}

输出格式示例：
title:  基本情况： 
content:  患者自述晚上偶尔腰部有酸痛感，饮食情况尚可但食量不大。

title: 治疗依从性：  
content:  患者能够按时服药，由其女儿协助准备药物。但是未按医嘱在一周后进行复查，计划下周再进行复查。`
}

// ==================== 组合提示词（用于最终内容生成） ====================

/**
 * 组合门诊病历的自定义提示词和对话内容
 * @param {string} customPrompt - 第一步生成的自定义提示词
 * @param {string} dialogueContent - 患者对话内容
 * @returns {string} 最终用于生成门诊病历的完整提示词
 */
function combinePromptWithDialogueOutpatient(customPrompt, dialogueContent) {
  return `${customPrompt}

以下是对话内容：${dialogueContent}

注意：
- 需要在字段前面标注title和content
- 仅输出纯文本，不需要添加任何格式

输出示例：
title: 主诉：
content: 夜间排尿频繁 2 天。

title: 现病史：
content: 2 天前出现夜尿增多，次日伴有轻度尿痛，无发热。`
}

/**
 * 组合教育查房的自定义提示词和对话内容
 * @param {string} customPrompt - 第一步生成的自定义提示词
 * @param {string} dialogueContent - 教育查房对话内容
 * @returns {string} 最终用于生成教育查房内容的完整提示词
 */
function combinePromptWithDialogueEducation(customPrompt, dialogueContent) {
  return `请根据以下教育查房记录内容，撰写一段完整的教育查房总结报告，要求语言专业规范、结构清晰，重点突出教学过程中的核心要点、问题分析与点评建议，不得编造未提供的信息。
${customPrompt}

以下是对话内容：${dialogueContent}

注意：
- 需要在字段前面标注title和content
- 仅输出纯文本，不需要添加任何格式

输出示例：
title: 带教提问内容：
content: 基于患者的临床表现和检查结果，你认为最有可能的诊断是什么？请列出你的诊断依据。

title: 规培回答内容：
content: 根据患者持续发热、咳嗽等症状加上胸部CT显示右下肺有炎症病灶，我初步判断可能是肺炎。但还需进一步做血常规等检查以排除其他可能性。`
}

// ==================== 向后兼容函数（已弃用） ====================

/**
 * [已弃用] 根据模板名称返回相应的prompt
 * 请使用新的专用函数
 * 
 * 保留此函数仅为向后兼容
 */
function getPromptForTemplate(templateName, content) {
  if (templateName === "门诊病历") {
    return getMetaPromptForOutpatient(content)
  } else if (templateName === "查房记录") {
    return getContentPromptForWardRound(content)
  } else if (templateName === "随访记录") {
    return getContentPromptForFollowup(content)
  } else if (templateName === "教育查房") {
    return getMetaPromptForEducationRound(content)
  } else {
    return ""
  }
}

module.exports = {
  getMetaPromptForOutpatient,
  getMetaPromptForEducationRound,
  getContentPromptForWardRound,
  getContentPromptForFollowup,
  combinePromptWithDialogueOutpatient,
  combinePromptWithDialogueEducation,
  getPromptForTemplate
}